{% extends 'menuAdministrador.html' %}
{% load static %}
{% block title %}Dashboard Administrativo{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- === Indicadores KPI (incluye comprobantes) === -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Total ventas</h6>
          <h3 class="text-warning">{{ kpi_total_ventas }}</h3>
          <div class="small text-muted">Acumulado hist√≥rico</div>
        </div>
      </div>
    </div>
   
    <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Ingreso promedio</h6>
          <h3 class="text-info">{{ kpi_promedio }}</h3>
          <div class="small text-muted">Ticket promedio</div>
        </div>
      </div>
    </div>
     <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Total compras</h6>
          <h3 class="text-success">{{ kpi_total_compras }}</h3>
          <div class="small text-muted">√ìrdenes registradas</div>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Ordenes Entregadas</h6>
          <h3 class="text-success">{{ comp_pagados }}</h3>
          <div class="small text-muted">Estado: Pa</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Ordenes Pendientes</h6>
          <h3 class="text-warning">{{ comp_pendientes }}</h3>
          <div class="small text-muted">Estado: Pe</div>
        </div>
      </div>
    </div>
        <div class="col-md-2">
      <div class="card bg-dark text-white border-0 shadow">
        <div class="card-body">
          <h6>Productos cr√≠ticos</h6>
          <h3 class="text-danger">{{ kpi_criticos }}</h3>
          <div class="small text-muted">Stock = m√≠nimo + 1</div>
        </div>
      </div>
    </div>
  </div>
  

  <!-- === Ventas por mes (izq) + √öltimos 7 d√≠as (der) === -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card bg-dark text-white shadow h-100">
        <div class="card-header fw-semibold">üìä Ventas por mes</div>
        <div class="card-body">
          <canvas id="graficoVentasTotales"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card bg-dark text-white shadow h-100">
        <div class="card-header fw-semibold">
          üìÖ Ventas √∫ltimos 7 d√≠as (total por d√≠a)
          <div class="small text-muted">
            Semana actual (lun‚Äìdom): {{ semana_del }} ‚Äì {{ semana_al }} ‚Ä¢ Total: <b>{{ total_semana_actual }}</b>
          </div>
        </div>
        <div class="card-body p-0">
          <table class="table table-dark table-striped mb-0">
            <thead>
              <tr>
                <th style="width:50%">Fecha</th>
                <th class="text-end" style="width:50%">Total ($)</th>
              </tr>
            </thead>
            <tbody>
              {% for r in dias_ultimos7_rows %}
              <tr>
                <td>{{ r.fecha }}</td>
                <td class="text-end">${{ r.total|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="2" class="text-center text-muted">Sin datos en los √∫ltimos 7 d√≠as</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- === Productos m√°s vendidos (izq) + Pr√≥ximos a agotarse (der) === -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card bg-dark text-white shadow h-100">
        <div class="card-header fw-semibold">üèÜ Productos m√°s vendidos (por cantidad)</div>
        <div class="card-body">
          <canvas id="graficoTopProductosCantidad"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card bg-dark text-white shadow h-100">
        <div class="card-header fw-semibold text-warning">‚ö†Ô∏è Productos pr√≥ximos a agotarse (Falta 1 para m√≠nimo)</div>
        <div class="card-body p-0">
          <table class="table table-dark table-striped mb-0">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Categor√≠a</th>
                <th>Stock</th>
                <th>M√≠nimo</th>
              </tr>
            </thead>
            <tbody>
              {% for p in productos_bajos %}
              <tr>
                <td>{{ p.nombre_producto }}</td>
                <td>{{ p.id_categoria.nombre_categoria }}</td>
                <td class="text-warning fw-semibold">{{ p.existencia_producto }}</td>
                <td>{{ p.cantidad_minima }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center text-muted">Todo en buen nivel ‚úÖ</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Pasando las variables de Django como objetos JSON
  let mesesLabels = JSON.parse('{{ meses_labels|safe }}');
  let ventasProductosDatos = JSON.parse('{{ ventas_productos_datos|safe }}');
  let ventasServiciosDatos = JSON.parse('{{ ventas_servicios_datos|safe }}');
  let productosLabels = JSON.parse('{{ productos_labels|safe }}');
  let productosCantidades = JSON.parse('{{ productos_cantidades|safe }}');
</script>
<script src="{% static 'js/graficosAdmin.js' %}"></script>
{% endblock %}
