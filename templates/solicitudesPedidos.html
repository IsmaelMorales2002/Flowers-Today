{% extends 'menu.html' %}
{% load static %}
{% block title %}Solicitud De Pedidos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.5/css/responsive.bootstrap5.css">
<link rel="stylesheet" href="{% static 'css/tablaCliente.css'%}" />

<div class="container mt-5">
  <h2 class="text-center text-white mb-4"><i class="bi bi-clipboard2-check"></i>Solicitudes De Pedidos</h2>
   
  <div class="table-responsive bg-white p-3 rounded shadow mb-2">
    <table id="tabla-pedidos" class="table table-striped table-bordered bg-white text-dark responsive">
      <thead class="table-light">
        <tr>
          <th class="text-center align-middle">Fecha</th>
          <th class="text-center align-middle">Descripcion Del Servicio</th>
          <th class="text-center align-middle">Categoria Del Servicio</th>
          <th class="text-center align-middle">Estado Del Servicio</th>
          <th class="text-center align-middle">Comentario Del Administrador</th>
        </tr>
      </thead>
      <tbody>
        {% for servicio in servicios %}
        <tr>
            <!-- Centramos vertical y horizontalmente usando align-middle + text-center -->
            <td class="text-center align-middle">{{servicio.fecha_servicio|date:"d/m/Y"}}</td>
            <td class="text-start align-middle">{{ servicio.descripcion_servicio }}</td>
            <td class="text-center align-middle">{{servicio.id_categoria_servicio.nombre_categoria_servicio}}</td>
            <td class="text-center align-middle">
            {% if servicio.estado_servicio == 'Re' %}
                <span class="badge bg-warning text-black">En Revision</span>
            {% elif servicio.estado_servicio == 'Ac' %}
                <span class="badge bg-success">Aceptado</span>
            {% elif servicio.estado_servicio == 'Ca' %}
                <span class="badge bg-danger">Rechazado</span>
            {% endif %}
            </td>
            <td class="text-center align-middle">
                <button 
                class="btn btn-sm text-white btn-ver-detalle" 
                style="background: #6C2DC7;"
                data-bs-toggle="modal"
                data-bs-target="#modalDetalleCompra"
                data-comentario="{{ servicio.comentario_servicio }}"
                data-id_servicio="{{ servicio.id_servicio }}"
                data-estado="{{ servicio.estado_servicio }}"
                data-precio="{{servicio.precio_servicio}}" >
                Ver Comentario
              </button>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Detalle del Comentario -->
<div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-labelledby="modalDetalleCompraLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 border-0 shadow">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title text-white" id="modalDetalleCompraLabel">Comentario del Administrador</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Comentario -->
        <p id="textoComentario" class="text-dark mb-3"></p>

        <!-- Precio -->
        <div class="text-center mb-4">
          <label class="fw-bold d-block">Precio del Servicio:</label>
          <p id="precioServicioDetalle" class="fs-5 text-success fw-semibold">$0.00</p>
        </div>

        <!-- Validación del usuario -->
        <div id="seccionValidacion">
          <p class="fw-bold mt-3 text-center">¿Aceptas?</p>
          <form method="POST" action="{% url 'RespuesCliente' %}">
            {% csrf_token %}
            <div class="d-flex justify-content-center gap-2">
              <input type="hidden" name="id_servicio" id="id_servicio">
              <button type="submit" name="respuesta" value="SI" class="btn text-white" style="background-color: #6C2DC7;">Sí</button>
              <button type="submit" name="respuesta" value="NO" class="btn btn-danger">No</button>
            </div>
          </form>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    let modal = document.getElementById('modalDetalleCompra');

    modal.addEventListener('show.bs.modal', function (event) {
        let button = event.relatedTarget;

        // Obtener datos del botón
        let comentario = button.getAttribute('data-comentario');
        let id_servicio = button.getAttribute('data-id_servicio');
        let precio = button.getAttribute('data-precio');

        // --- Mostrar precio en el modal ---
        let precioElemento = modal.querySelector('#precioServicioDetalle');
        if (precio && !isNaN(precio)) {
            precioElemento.textContent = `$${parseFloat(precio).toFixed(2)}`;
        } else {
            precioElemento.textContent = '$0.00';
        }

        // Obtener estado desde la tabla
        let estado = button.closest('tr')
            .querySelector('td:nth-child(4)')
            .innerText
            .trim();

        // Limpiar el comentario (remueve True o False)
        let comentarioLimpio = (comentario || "")
            .replace(/true|false/gi, '')
            .replace(/\s+/g, ' ')
            .trim();

        // Mostrar comentario limpio
        let modalBody = modal.querySelector('#textoComentario');
        modalBody.textContent = comentarioLimpio || 'No hay comentario';

        // Asignar ID al formulario
        modal.querySelector('#id_servicio').value = id_servicio;

        // Mostrar u ocultar la sección de validación según estado
        let seccion = document.getElementById("seccionValidacion");
        let ocultarValidacion =
            estado === "Aceptado" ||
            estado === "Rechazado" ||
            comentarioLimpio === "" ||
            comentario === null;

        if (ocultarValidacion) {
            seccion.style.display = "none";
        } else {
            seccion.style.display = "block";
        }

        // Centrar los botones siempre
        let botones = seccion.querySelector(".d-flex");
        if (botones) {
            botones.style.justifyContent = "center";
        }
    });
});
</script>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.5/js/dataTables.responsive.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.5/js/responsive.bootstrap5.js"></script>
<script src="{% static 'js/dataTablePedidos.js'%}"></script>
{% endblock %}
